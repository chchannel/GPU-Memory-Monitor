# GPUメモリ監視プログラム 開発作業履歴ログ (2026/02/04)

## 1. プロジェクト概要
GPUメモリの使用状況をリアルタイムで監視し、どのアプリケーションがどの程度のメモリを占有しているかを一目で把握するためのツールを開発しました。

## 2. 開発の主な変遷と技術的課題の解決

### 段階 1: 基本実装と終了機能の模索
- **初期目標**: 監視に加え、右クリック等でのプロセス終了機能の実装。
- **課題**: `nvidia-smi` の `--query-compute-apps` だけでは、描画メインのアプリ（Firefox, Eagle等）がリストに表示されない。
- **解決**: `pmon` モードや `--query-accounted-apps` を併用するロジックを導入。

### 段階 2: 安定性へのピボット (監視専用化)
- **課題**: Firefox等のシステム依存が強いアプリを終了させると、ブラウザが即座に再起動したり、システムが不安定になる挙動を確認。
- **判断**: ユーザー要望に基づき「終了機能」を削除し、純粋な監視アプリへとシフト。UIをよりコンパクトに整理。

### 段階 3: モニタリング精度の壁 (N/A表示の克服)
- **課題**: GeForce環境において、`nvidia-smi` がプロセスごとのメモリ使用量を `N/A`（利用不可）と返し、アプリごとの使用量が 0MB になる現象が発生。
- **解決 (ブレイクスルー)**: Windows標準の **パフォーマンスカウンター (\GPU Process Memory)** から直接データを取得する方式を採用。これにより、Firefox等のブラウザ使用量も1MB単位で正確に追跡可能に。

### 段階 4: パフォーマンス改善 (ラグの解消)
- **課題**: パフォーマンスカウンターの取得（PowerShell実行）が重く、データ更新時にスクロールが数秒間フリーズする。
- **解決**: 
  - `QThread` による非同期実行を導入し、メイン（UI）スレッドを解放。
  - リストの更新を「差分更新」に変更し、ウィジェットの再利用を徹底。

### 段階 5: EXE化後のウィンドウポップアップ対応
- **課題**: EXEファイルとして実行した際、3秒ごとのデータ取得（PowerShell実行）のたびに一瞬だけ黒いコンソールウィンドウが表示され、作業中のフォーカスが奪われる。
- **解決**: `subprocess.run` の呼び出しに `creationflags=subprocess.CREATE_NO_WINDOW` を指定。これにより、バックグラウンド処理を完全に非表示にし、ユーザーの作業を妨げないように改善。

### 段階 6: ウィンドウ操作性の向上と高度な機能追加
- **追加機能**:
  - **自由リサイズ**: ウィンドウサイズをマウスで自由に変更可能に。
  - **最前面固定 (📌)**: 常に他のアプリより前に表示し続けるピン留め機能を追加。
  - **コンパクトモード (🔳)**: ヘッダーを隠し、最小限のリストだけで表示する省スペースモードを搭載。

### 段階 7: UI レスポンシブ対応とコンパクトモード強化
- **課題**: 横幅を極端に狭めた際、アプリのメモリ使用量が隠れてしまう。また、コンパクトモード時にGPU全体の負荷が見えなくなる。
- **解決**: 
  - **ElidedLabel の導入**: アプリ名が長い場合でも、メモリ使用量が隠れないように名前の末尾を自動で省略（...表示）する仕組みを実装。
  - **インライン・負荷計器**: コンパクトモード時でも、コントロール行に「GPU: ○○%」とインラインで表示し続けるように改良。

### 段階 8: テーマ機能（🎨）の実装とボタン名称の洗練
- **UI改善**:
  - **テーマの多様化**: 🎨ボタンをクリックすることで、**ライト・グレー・ダーク**の3つの外観を即座に切り替え可能に。

### 段階 9: UIのシンプル化（フィルタ機能のオミット）
- **判断**: 「0MB非表示」ボタンがUIを複雑化させていたため、ユーザーの要望に基づき機能を削除。
- **解決**: 
  - フィルタボタンと関連ロジックを完全にオミット。
  - プロセスリストのデータ更新を簡略化し、UIをよりクリーンで実用的なものに整理。

## 3. 今後のメンテナンス用メモ
- **データ取得ノイズ**: パフォーマンスカウンターは、ごく稀にPIDの紐付けが遅れることがありますが、次回の更新（3秒後）で自動的に補完されます。
- **ビルド設定**: PyInstallerで `--onefile --windowed` オプションを使用しています。
- **依存ライブラリ**: `PySide6`, `psutil`
